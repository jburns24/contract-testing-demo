name: Pact Provider - Checkout Service

on:
  push:
    branches: [main]
    paths:
      - 'src/checkout/**'
      - 'src/accounting/tests/pacts/**/*.json'
      - '.github/workflows/checkout-provider-pact.yml'
  pull_request:
    paths:
      - 'src/checkout/**'
      - 'src/accounting/tests/pacts/**/*.json'
      - '.github/workflows/checkout-provider-pact.yml'
  workflow_dispatch:

jobs:
  pact-provider-tests:
    name: Run provider pact verification tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: src/checkout

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: 'src/checkout/go.sum'

      - name: Install Pact FFI library
        run: |
          # Install pact-go tool and FFI library for contract verification
          go install github.com/pact-foundation/pact-go/v2@latest

          # Add Go bin directory to PATH for this step
          export GOPATH=$HOME/go
          export PATH=$PATH:$GOPATH/bin

          # Install FFI library to a user-writable location
          sudo pact-go -l DEBUG install

      - name: Download dependencies
        run: go mod download

      - name: Build checkout service
        run: go build -o checkout .

      - name: Run provider pact verification tests
        # Run the port-based contract tests that exercise the OrderEventPublisher interface
        env:
          # Provide broker details for the test code (PACT_BROKER_URL) **and** for the Pact CLI (PACT_BROKER_BASE_URL)
          PACT_BROKER_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_USERNAME: ${{ secrets.PACT_BROKER_USERNAME }}
          PACT_BROKER_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }}
        run: |
          # Expose commit SHA and branch name to the test binary so it can publish results
          export GIT_COMMIT=$(git rev-parse HEAD)
          export GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

          # Run the port-based contract verification tests
          # These tests exercise the OrderEventPublisher port interface with hexagonal architecture
          go test -v -run TestOrderEventPublisherContract --no-fail-fast

      - name: Can I Deploy?
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_USERNAME: ${{ secrets.PACT_BROKER_USERNAME }}
          PACT_BROKER_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }}
        run: |
          # Skip deployment check if broker URL is not configured
          if [ -z "$PACT_BROKER_BASE_URL" ]; then
            echo "PACT_BROKER_URL secret not set ‚Äì skipping deployment check.";
            exit 0;
          fi

          GIT_COMMIT=$(git rev-parse HEAD)
          # Use Pact CLI to check if this provider version can be deployed
          docker run --rm \
            -e PACT_BROKER_BASE_URL \
            -e PACT_BROKER_USERNAME \
            -e PACT_BROKER_PASSWORD \
            pactfoundation/pact-cli:latest \
            broker can-i-deploy \
            --pacticipant checkout-provider \
            --version ${GIT_COMMIT} \
            --to production

      - name: Deploy (placeholder)
        run: |
          echo "‚úÖ Deploying Checkout Service with hexagonal architecture..."
          echo "   - OrderEventPublisher port validated"
          echo "   - KafkaOrderEventPublisher adapter verified"
          echo "   - Contract compatibility confirmed"
          echo "   (deployment placeholder - would build and push Docker image)"

      - name: Tag provider version as production
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_USERNAME: ${{ secrets.PACT_BROKER_USERNAME }}
          PACT_BROKER_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }}
        run: |
          # Skip tagging if pact broker URL is not configured
          if [ -z "$PACT_BROKER_BASE_URL" ]; then
            echo "PACT_BROKER_URL secret not set ‚Äì skipping production tagging.";
            exit 0;
          fi

          GIT_COMMIT=$(git rev-parse HEAD)
          # Mark this provider version as deployed to production in the Pact Broker
          docker run --rm \
            -e PACT_BROKER_BASE_URL \
            -e PACT_BROKER_USERNAME \
            -e PACT_BROKER_PASSWORD \
            pactfoundation/pact-cli:latest \
            broker create-or-update-version \
            --pacticipant checkout-provider \
            --version ${GIT_COMMIT} \
            --tag production

          echo "üè∑Ô∏è Tagged checkout-provider version ${GIT_COMMIT} as production in Pact Broker"
          echo "   This enables consumers to validate against this verified provider version"
