name: Pact Consumer - Accounting

on:
  push:
    branches: [main]
    paths:
      - 'src/accounting/src/**'
      - 'src/accounting/tests/**'
      - 'src/accounting/src/Accounting.csproj'
      - 'src/accounting/tests/tests.csproj'
      - '.github/workflows/accounting-consumer-pact.yml'
  pull_request:
    paths:
      - 'src/accounting/src/**'
      - 'src/accounting/tests/**'
      - 'src/accounting/src/Accounting.csproj'
      - 'src/accounting/tests/tests.csproj'
      - '.github/workflows/accounting-consumer-pact.yml'

jobs:
  pact-consumer-tests:
    name: Run consumer pact tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/accounting
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Copy protobuf files
        run: |
          # Copy proto files from the shipping service to the accounting service
          make generate-protobuf

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run consumer pact tests
        run: dotnet test tests/tests.csproj --no-build --configuration Release --verbosity normal

      - name: Publish Pact contracts (optional)
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_USERNAME: ${{ secrets.PACT_BROKER_USERNAME }}
          PACT_BROKER_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }}
        run: |
          # Skip publish if broker URL is not configured
          if [ -z "$PACT_BROKER_BASE_URL" ]; then
            echo "PACT_BROKER_URL secret not set – skipping publish step.";
            exit 0;
          fi

          GIT_COMMIT=$(git rev-parse HEAD)
          GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

          echo "Publishing Pacts for commit $GIT_COMMIT (branch: $GIT_BRANCH)"

          # Pull the latest Pact CLI image
          docker pull pactfoundation/pact-cli:latest

          # Publish the pacts generated by the tests
          docker run --rm \
            -v "${{ github.workspace }}/src/accounting/tests/pacts:/pacts" \
            pactfoundation/pact-cli:latest publish /pacts \
            --consumer-app-version="$GIT_COMMIT" \
            --branch="$GIT_BRANCH" \
            --broker-base-url="$PACT_BROKER_BASE_URL" \
            --broker-username="$PACT_BROKER_USERNAME" \
            --broker-password="$PACT_BROKER_PASSWORD"

      - name: Can I Deploy?
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_USERNAME: ${{ secrets.PACT_BROKER_USERNAME }}
          PACT_BROKER_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }}
        run: |
          # Skip deployment check if pact broker URL is not configured
          if [ -z "$PACT_BROKER_BASE_URL" ]; then
            echo "PACT_BROKER_URL secret not set – skipping deployment check.";
            exit 0;
          fi

          GIT_COMMIT=$(git rev-parse HEAD)

          # Check if it's safe to deploy
          docker run --rm \
            -e PACT_BROKER_BASE_URL \
            -e PACT_BROKER_USERNAME \
            -e PACT_BROKER_PASSWORD \
            pactfoundation/pact-cli:latest \
            broker can-i-deploy \
            --pacticipant accounting-consumer \
            --version ${GIT_COMMIT} \
            --to production

  # Deployment gate job that depends on contract validation
  deployment-gate:
    name: Contract validation gate
    runs-on: ubuntu-latest
    needs: pact-consumer-tests
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Deployment approved
        run: |
          echo "✅ Contract validation passed - accounting service is safe to deploy"
          echo "All consumer contracts are satisfied by current providers"
          echo "This job serves as a deployment gate for production deployments"
