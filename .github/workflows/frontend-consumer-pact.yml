name: Pact Consumer - Frontend

on:
  push:
    paths:
      - 'src/frontend/gateways/http/**'
      - 'src/frontend/**/*.spec.ts'
      - 'src/frontend/package.json'
      - '.github/workflows/frontend-consumer-pact.yml'
  pull_request:
    paths:
      - 'src/frontend/gateways/http/**'
      - 'src/frontend/**/*.spec.ts'
      - 'src/frontend/package.json'
      - '.github/workflows/frontend-consumer-pact.yml'

jobs:
  pact-consumer-tests:
    name: Run consumer pact tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'src/frontend/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run consumer pact tests
        run: npm run test:pact

      - name: Publish Pact contracts (optional)
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_USERNAME: ${{ secrets.PACT_BROKER_USERNAME }}
          PACT_BROKER_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }}
        run: |
          # Skip publish if broker URL is not configured
          if [ -z "$PACT_BROKER_BASE_URL" ]; then
            echo "PACT_BROKER_URL secret not set â€“ skipping publish step.";
            exit 0;
          fi

          GIT_COMMIT=$(git rev-parse HEAD)
          GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

          echo "Publishing Pacts for commit $GIT_COMMIT (branch: $GIT_BRANCH)"

          # Pull the latest Pact CLI image
          docker pull pactfoundation/pact-cli:latest

          # Publish the pacts generated by the tests
          docker run --rm \
            -v "${{ github.workspace }}/src/frontend/pacts:/pacts" \
            pactfoundation/pact-cli:latest publish /pacts \
            --consumer-app-version="$GIT_COMMIT" \
            --branch="$GIT_BRANCH" \
            --broker-base-url="$PACT_BROKER_BASE_URL" \
            --broker-username="$PACT_BROKER_USERNAME" \
            --broker-password="$PACT_BROKER_PASSWORD"

      - name: Can I Deploy?
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_URL }}
          PACT_BROKER_USERNAME: ${{ secrets.PACT_BROKER_USERNAME }}
          PACT_BROKER_PASSWORD: ${{ secrets.PACT_BROKER_PASSWORD }}
        run: |
          GIT_COMMIT=$(git rev-parse HEAD)

          # Check if it's safe to deploy
          docker run --rm \
            -e PACT_BROKER_BASE_URL \
            -e PACT_BROKER_USERNAME \
            -e PACT_BROKER_PASSWORD \
            pactfoundation/pact-cli:latest \
            broker can-i-deploy \
            --pacticipant Frontend \
            --version ${GIT_COMMIT} \
            --to production
